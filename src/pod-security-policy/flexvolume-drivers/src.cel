variables:
- name: flexVolumes
  expression: |
    !has(variables.anyObject.spec.volumes) ? [] :
      variables.anyObject.spec.volumes.filter(volume, has(volume.flexVolume))
- name: allowedFlexVolumeDrivers
  expression: variables.params.allowedFlexVolumes.map(volume, volume.driver)
- name: badFlexVolumeNames
  expression: |
    variables.flexVolumes.map(volume,
      !has(volume.flexVolume.driver) || !(volume.flexVolume.driver in variables.allowedFlexVolumeDrivers),
      volume.name
    )
validations:
- expression: '(has(request.operation) && request.operation == "UPDATE") || size(variables.badFlexVolumeNames) == 0'
  messageExpression: |
    "FlexVolumes [" + variables.badFlexVolumeNames.join(", ") + "] not allowed, pod: " + variables.anyObject.metadata.name + ". Allowed drivers: [" + variables.allowedFlexVolumeDrivers.join(", ") + "]" 